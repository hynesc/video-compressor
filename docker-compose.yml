services:
  8mblocal:
    image: jms1717/8mblocal:latest
    container_name: 8mblocal
    ports:
      - "8001:8001"
    volumes:
      - ./.env:/app/.env
      # Mount patched files for Quality Mode and UI Banner
      - ./patches/worker/worker.py:/app/worker/worker.py
      - ./patches/backend/main.py:/app/backend/main.py
      - ./patches/frontend-build/index.html:/app/frontend-build/index.html
    
    # Store uploads and outputs in RAM (tmpfs) for privacy
    tmpfs:
      - /app/uploads
      - /app/outputs
    
    # Enable NVIDIA GPU support
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    environment:
      - REDIS_URL=redis://127.0.0.1:6379/0
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
      # WORKER_CONCURRENCY=4 # Optional: Adjust based on your CPU/GPU capacity
    
    restart: unless-stopped